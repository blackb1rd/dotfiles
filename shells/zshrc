#!/bin/zsh
export TERM="xterm-256color"

case $(uname -a) in
  *Microsoft*)
    unsetopt BG_NICE
    ;;
esac

# sources external in folder .shells
for file in $HOME/.shells/zsh/*
do
  source $file
done

autoload -Uz compinit
typeset -i updated_at=$(date +'%j' -r ~/.zcompdump 2>/dev/null || stat -f '%Sm' -t '%j' ~/.zcompdump 2>/dev/null)
if [ $(date +'%j') != $updated_at ]; then
  compinit -i
else
  compinit -C -i
fi
zmodload -i zsh/complist
HISTFILE=$HOME/.zsh_history
HISTSIZE=100000
SAVEHIST=$HISTSIZE
setopt hist_ignore_all_dups # remove older duplicate entries from history
setopt hist_reduce_blanks # remove superfluous blanks from history items
setopt inc_append_history # save history entries as soon as they are entered
setopt share_history # share history between different instances of the shell

eval $( dircolors -b $HOME/.dircolors )
LS_OPTIONS="--color=auto"

# aliases
alias ls='ls $LS_OPTIONS'
alias dir='ls -l'
alias ll='ls -l'
alias la='ls -la'
alias l='ls -alF'
alias d='ls -l -L'

zstyle ':completion::complete:*' use-cache on
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion:*:default' list-colors ${(s.:.)LS_COLORS}
zstyle ':completion:*:*:kill:*:processes' list-colors '=(#b) #([0-9]#)*=0=01;31'
zstyle ':completion:*' menu select
zstyle ':completion:*:*:kill:*' menu select=1 _complete _ignored _approximate
zstyle ':completion:*' group-name ''
zstyle ':completion:*:*:git:*' script $HOME/.shells/git/git-completion.zsh

# Add Path
pathadd "/sbin"
pathadd "/snap/bin"
pathadd "$HOME/.go/bin/"
export ANDROID_HOME=$HOME/Android/Sdk
pathadd "$ANDROID_HOME/emulator"
pathadd "$ANDROID_HOME/tools"
pathadd "$ANDROID_HOME/tools/bin"
pathadd "$ANDROID_HOME/platform-tools"
pathadd "$(yarn global bin)"
pathadd "$HOME/development/flutter/bin"

case $(uname) in
  CYGWIN_NT-* | MSYS_NT-* )
    export EDITOR=vim
    pathadd "/mingw64/bin"
    export GOROOT=/mingw64/lib/go
    export GOPATH=/mingw64
    ;;
  * )
    if [ -d "$HOME/.go" ] ; then
      export GOPATH=$HOME/.go
    fi

    if [ -d "$HOME/.pyenv" ] ; then
      export PYENV_ROOT=$HOME/.pyenv
      if [ -d "$PYENV_ROOT/bin" ] ; then
        pathadd "$PYENV_ROOT/bin"
      else
        pathadd "$PYENV_ROOT/shims"
      fi
      if command -v pyenv > /dev/null 2>&1; then
        eval "$(pyenv init - --no-rehash)"
        eval "$(pyenv virtualenv-init -)"
      fi
      pyenv activate py3nvim 2> /dev/null
      if [[ -n $VIRTUAL_ENV && -e "${VIRTUAL_ENV}/bin/activate" ]]; then
        source "${VIRTUAL_ENV}/bin/activate"
      fi
    fi

    if [ -d "$HOME/.rbenv" ] ; then
      pathadd "$HOME/.rbenv/bin"
      eval "$(rbenv init -)"
    fi


    export PYTHONSTARTUP=$HOME/.pythonrc
    if [[ -x $(command -v nvim) ]] ; then
      export EDITOR=nvim
      alias vim="nvim"
      alias vimdiff='nvim -d'
    else
      export EDITOR=vim
    fi

    if [ -d "/usr/local/go/bin" ] ; then
      pathadd "/usr/local/go/bin"
    elif [ -f "/etc/os-release" ] ; then
      os_release_id="$(grep -E '^ID=([a-zA-Z]*)' /etc/os-release | cut -d '=' -f 2)"
      os_version_id="$(grep -E '^VERSION_ID="([0-9\.]*)"' /etc/os-release | cut -d '=' -f 2 | tr -d '"')"
      case "$os_release_id" in
        "ubuntu")
          case "$os_version_id" in
            "16.04" | "18.04" | "18.10")
              export GOROOT=/usr/lib/go-1.13/
              pathadd "/usr/lib/go-1.13/bin"
            ;;
            *)
              export GOROOT=/usr/lib/go-1.10/
              pathadd "/usr/lib/go-1.10/bin"
            ;;
          esac
          ;;
        "debian")
          if [ -d "/usr/local/go" ] ; then
            export GOROOT=/usr/local/go/
            pathadd "/usr/local/go/bin"
          fi
      esac
    fi
    ;;
esac

zsh_custom_ip(){
  local ip
  case $(uname) in
    CYGWIN_NT-* | MSYS_NT-*)
      ip=$(route print 2>&1 | grep -P "^ +0.0.0.0 +0.0.0.0 +" | awk '{print $4}')
      ;;
    *)
      if [[ -n $(ifconfig | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*') ]] ; then
        ip=$(ifconfig | \
          grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | \
          grep -Eo '([0-9]*\.){3}[0-9]*' | \
          grep -v '127.0.0.1' | \
          awk 'FNR==1{print $1}')
      else
        ip=$(route 2>&1 | awk 'FNR==3{print $1}')
      fi
      ;;
  esac
  local color="%F{black}"
  echo -n "%{$color%}$ip"
}

export ANTIBODY_HOME="$HOME/.cache/antibody"
POWERLEVEL9K_MODE='nerdfont-complete'
POWERLEVEL9K_DIR_HOME_SUBFOLDER_BACKGROUND='green'
POWERLEVEL9K_DIR_SHORTEN_LENGTH=2
POWERLEVEL9K_DIR_SHORTEN_STRATEGY="truncate_from_right"
POWERLEVEL9K_PROMPT_ON_NEWLINE=true
POWERLEVEL9K_RPROMPT_ON_NEWLINE=true
POWERLEVEL9K_MULTILINE_FIRST_PROMPT_PREFIX="%K{green}%k"
POWERLEVEL9K_MULTILINE_LAST_PROMPT_PREFIX="%K{028}%F{black}%f%F{028}%k%f "
POWERLEVEL9K_CUSTOM_IP="zsh_custom_ip"
POWERLEVEL9K_CUSTOM_IP_BACKGROUND=green
POWERLEVEL9K_TIME_FORMAT="\uf017 %D{%H:%M} \uf073 %D{%d.%m.%y}"
POWERLEVEL9K_TIME_BACKGROUND=cyan
POWERLEVEL9K_LEFT_PROMPT_ELEMENTS=(os_icon dir dir_writable vcs)
POWERLEVEL9K_RIGHT_PROMPT_ELEMENTS=(time custom_ip background_jobs ram pyenv rbenv)
DEFAULT_USER=`whoami`

DISABLE_AUTO_UPDATE=true
ZSH="$ANTIBODY_HOME/https-COLON--SLASH--SLASH-github.com-SLASH-robbyrussell-SLASH-oh-my-zsh"
ZSH_AUTOSUGGEST_STRATEGY=(history completion)
source $HOME/.zsh_plugins.sh

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
